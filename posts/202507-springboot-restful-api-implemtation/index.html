<!doctype html><html lang=tw><head><title>課程筆記 Spring Boot 與 Spring Security 實作 RESTful API :: kinako890419</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part 0: 大綱 專案目標 建立一個家庭零用錢管理應用：
利用 Spring Boot 創建 RESTful API 與網頁應用 Spring Data, Spring Security 初探 專案導向的課程 Test-First 開發方法: 通常會在實作之前編寫測試 內容總覽 RESTful API 基礎設計原則 測試導向開發（TDD） 使用 Spring Boot 開發 RESTfulAPI Spring Security 應用 安全性機制與風險防護 "><meta name=keywords content="Spring Boot 課程筆記,Spring Academy 筆記"><meta name=robots content="noodp"><meta name=google-site-verification content="lr5h4speGPgLu9Px91dSXi0VOcHNyEwf5nhnJVYNUMo"><link rel=canonical href=https://kinako890419.github.io/blog/posts/202507-springboot-restful-api-implemtation/><link rel=stylesheet href=https://kinako890419.github.io/blog/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/terminal.min.4cacd2346817eaed5e2ca0fa96fb1a9e9d544953eaf573b95dc602785bd8c033.css><link rel=stylesheet href=https://kinako890419.github.io/blog/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://kinako890419.github.io/blog/favicon.png><link rel=apple-touch-icon href=https://kinako890419.github.io/blog/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="tw"><meta property="og:type" content="article"><meta property="og:title" content="課程筆記 Spring Boot 與 Spring Security 實作 RESTful API"><meta property="og:description" content="Part 0: 大綱 專案目標 建立一個家庭零用錢管理應用：
利用 Spring Boot 創建 RESTful API 與網頁應用 Spring Data, Spring Security 初探 專案導向的課程 Test-First 開發方法: 通常會在實作之前編寫測試 內容總覽 RESTful API 基礎設計原則 測試導向開發（TDD） 使用 Spring Boot 開發 RESTfulAPI Spring Security 應用 安全性機制與風險防護 "><meta property="og:url" content="https://kinako890419.github.io/blog/posts/202507-springboot-restful-api-implemtation/"><meta property="og:site_name" content="kinako890419"><meta property="og:image" content="https://kinako890419.github.io/blog/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-07-04 00:00:00 +0800 +0800"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/blog/tags/homepage/><div class=logo>kinako890419里民活動中心</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/blog/>Home</a></li><li><a href=/blog/posts>Posts</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/blog/>Home</a></li><li><a href=/blog/posts>Posts</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://kinako890419.github.io/blog/posts/202507-springboot-restful-api-implemtation/>課程筆記 Spring Boot 與 Spring Security 實作 RESTful API</a></h1><div class=post-meta><time class=post-date>2025-07-04</time><span class=post-reading-time>12 min read (2523 words)</span></div><span class=post-tags>#<a href=https://kinako890419.github.io/blog/tags/%E8%AA%B2%E7%A8%8B%E7%AD%86%E8%A8%98/>課程筆記</a>&nbsp;
#<a href=https://kinako890419.github.io/blog/tags/springacademy/>SpringAcademy</a>&nbsp;
#<a href=https://kinako890419.github.io/blog/tags/springboot/>SpringBoot</a>&nbsp;</span><div class=post-content><div><h1 id=part-0-大綱>Part 0: 大綱<a href=#part-0-大綱 class=hanchor arialabel=Anchor>#</a></h1><h2 id=專案目標>專案目標<a href=#專案目標 class=hanchor arialabel=Anchor>#</a></h2><p>建立一個家庭零用錢管理應用：</p><ul><li>利用 Spring Boot 創建 <strong>RESTful API</strong> 與網頁應用</li><li>Spring Data, Spring Security 初探</li><li>專案導向的課程</li><li>Test-First 開發方法: 通常會在實作之前編寫測試</li></ul><h2 id=內容總覽>內容總覽<a href=#內容總覽 class=hanchor arialabel=Anchor>#</a></h2><ol><li>RESTful API 基礎設計原則</li><li>測試導向開發（TDD）</li><li>使用 Spring Boot 開發 RESTfulAPI</li><li>Spring Security 應用</li><li>安全性機制與風險防護</li></ol><h2 id=檔案架構>檔案架構<a href=#檔案架構 class=hanchor arialabel=Anchor>#</a></h2><pre tabindex=0><code>📦 src
├── 📁 main
│   ├── 📁 java
│   │   └── 📁 com.springacademy.cashcard
│   │       ├── 📄 CashCard.java             // 資料 Entity：代表一筆 CashCards，包含 id、amount、owner
│   │       ├── 📄 CashcardApplication.java  // 應用啟動入口（Spring Boot main class）
│   │       ├── 📄 CashCardController.java   // 負責接收 REST API 請求，回傳 HTTP 回應（GET/POST/PUT/DELETE）
│   │       ├── 📄 CashCardRepository.java   // 資料存取介面：繼承自 `CrudRepository` 和 `PagingAndSortingRepository`，提供資料庫 CRUD 功能
│   │       └── 📄 SecurityConfig.java       // Spring Security 安全性設定：角色權限、開啟/關閉 CSRF、HTTP Basic 認證
│   │
│   └── 📁 resources
│       ├── 📁 static
│       ├── 📁 templates
│       ├── 📄 application.properties
│       └── 📄 schema.sql                    // 專案啟動時會自動執行，用來建立 `CASH_CARD` 資料表
│
├── 📁 test
│   ├── 📁 java
│   │   └── 📁 com.springacademy.cashcard
│   │       ├── 📄 CashCardApplicationTests.java // 驗證 API 行為正確性
│   │       └── 📄 CashCardJsonTest.java         // JSON 測試：確認序列化與反序列化是否正確
│   │
│   └── 📁 resources
│       ├── 📁 com.springacademy.cashcard
│       │   ├── 📄 expected.json             // 單筆資料的預期 JSON 格式（for JSON 測試）
│       │   └── 📄 list.json                 // 多筆資料的預期 JSON 格式（for JSON 測試）
│       └── 📄 data.sql                      // 測試資料 SQL：在測試執行前匯入資料
</code></pre><hr><h1 id=part1-spring-boot-開發-restful-api-與-tdd-初探>Part1: Spring Boot 開發 Restful API 與 TDD 初探<a href=#part1-spring-boot-開發-restful-api-與-tdd-初探 class=hanchor arialabel=Anchor>#</a></h1><h2 id=idempotence冪等性-and-http>Idempotence（冪等性） and HTTP<a href=#idempotence冪等性-and-http class=hanchor arialabel=Anchor>#</a></h2><ul><li>Idempotence代表不管執行多少次，都可以得到相同的結果，不會有副作用、不會改變狀態</li><li>HTTP Methods當中，<code>GET</code>、<code>PUT</code>、<code>DELETE</code>是冪等的，而<code>POST</code>和<code>PATCH</code>不是</li><li>例如新增一筆交易(POST)，應用如果使用自動生成的ID來辨識交易，每一筆交易的ID都會不同，因此不是冪等的</li></ul><table><thead><tr><th>方法</th><th>用途</th><th>是否 Idempotent</th><th>常見用途說明</th></tr></thead><tbody><tr><td><strong>GET</strong></td><td>取得資源</td><td>✅ 是</td><td>查詢資料、讀取清單或單筆資料</td></tr><tr><td><strong>POST</strong></td><td>建立資源／提交資料</td><td>❌ 否</td><td>新增資料（如建立帳戶、下訂單）</td></tr><tr><td><strong>DELETE</strong></td><td>刪除資源</td><td>✅ 是</td><td>刪除特定資源（如刪除帳號）</td></tr><tr><td><strong>PUT</strong></td><td>整份更新／建立資源</td><td>✅ 是</td><td>更新<em>整個資源</em>內容，或直接設定資源</td></tr><tr><td><strong>PATCH</strong></td><td>部分更新資源</td><td>❌ 否（不能保證）</td><td>修改部分欄位（如改密碼、加分）</td></tr></tbody></table><ul><li>冪等性影響到是否可重試：如果這個請求失敗了（例如網路斷線、伺服器沒回應），能不能放心地再發一次同樣的請求，而不用擔心會造成錯誤或重複副作用？</li><li>PATCH方法無法保證每次都可以符合冪等性</li></ul><h2 id=uri-url-uri-的區別>URI, URL, URI 的區別<a href=#uri-url-uri-的區別 class=hanchor arialabel=Anchor>#</a></h2><h3 id=uri-uniform-resource-identifiers>URI (Uniform Resource Identifiers)<a href=#uri-uniform-resource-identifiers class=hanchor arialabel=Anchor>#</a></h3><ul><li>URI的功能是用於識別web上的資源，可能是文件、照片&mldr;等</li><li>發送HTTP請求時，請求的目標通常是一個URI</li><li>最常見的 URI 類型是 URL</li><li>URI 除了用來取得資源（例如打開網頁、下載圖片）之外，還可以觸發不同的行為。例如開啟email程式 <code>&lt;a href="mailto:someone@example.com">寄信給我們&lt;/a></code><ul><li>這些 URI 通常用在 HTML 的 <code>&lt;a></code> 標籤中的 <code>href</code> 屬性，透過使用者點擊連結時觸發特定行為</li></ul></li></ul><h4 id=uri-的組成格式>URI 的組成格式<a href=#uri-的組成格式 class=hanchor arialabel=Anchor>#</a></h4><h5 id=schemes>Schemes<a href=#schemes class=hanchor arialabel=Anchor>#</a></h5><ul><li>位於URI的最開頭，指定瀏覽器必須使用哪種協議來獲取資源</li></ul><h5 id=authority>Authority<a href=#authority class=hanchor arialabel=Anchor>#</a></h5><ul><li>位於Schemes的後面，Path之前的部分</li><li>包含用戶資訊、host和port</li></ul><h5 id=path>Path<a href=#path class=hanchor arialabel=Anchor>#</a></h5><ul><li>位於Authority之後，資料通常是階層式組成(hierarchical form)</li><li>目的是在 URI 所屬的範圍內，識別出特定的資源</li></ul><h5 id=query>Query<a href=#query class=hanchor arialabel=Anchor>#</a></h5><ul><li>位於Path之後，對資源進一步提供查詢條件或參數</li></ul><h5 id=fragment>Fragment<a href=#fragment class=hanchor arialabel=Anchor>#</a></h5><ul><li>URI 的最後一部分，以 <code>#</code> 開頭</li><li>用於標識資源中的特定部分，例如文檔的其中一部分</li></ul><h3 id=url-uniform-resource-locator>URL (Uniform Resource Locator)<a href=#url-uniform-resource-locator class=hanchor arialabel=Anchor>#</a></h3><ul><li>URI的子集，用於網路資源的定位</li><li>URL和URI可以視為是一樣的東西，捨棄嚴格的劃分方式，整合URI、URL及URN (<a href=https://www.w3.org/TR/uri-clarification/>source</a>)</li></ul><h3 id=urn>URN<a href=#urn class=hanchor arialabel=Anchor>#</a></h3><ul><li>指定資源的<strong>名稱</strong></li></ul><hr><ul><li><a href=https://stackoverflow.com/questions/4913343/what-is-the-difference-between-uri-url-and-urn>What is the difference between URI, URL and URN?</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/URI>URIs - MDN Web Docs - Mozilla</a></li><li><a href=https://developer.mozilla.org/en-US/docs/Learn_web_development/Howto/Web_mechanics/What_is_a_URL>What is a URL? - Learn web development | MDN</a></li><li><a href=https://hackmd.io/@CynthiaChuang/URI-URL-and-URN>URI、URL 與URN - HackMD</a></li><li><a href=https://hackmd.io/@BrentKao/BJMfdJ2O2>URI 跟URL差異 - HackMD</a></li></ul><hr><h2 id=test-driven-development-tdd>Test Driven Development (TDD)<a href=#test-driven-development-tdd class=hanchor arialabel=Anchor>#</a></h2><blockquote><p>撰寫測試程式 (提供API開發一個指引) ⭢ 實作API以符合測試</p></blockquote><ol><li>測試序列化與反序列化</li><li>測試API的正確性</li></ol><h3 id=jsontest測試序列化與反序列化><code>@JsonTest</code>測試序列化與反序列化<a href=#jsontest測試序列化與反序列化 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> com.springacademy.cashcard;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> org.assertj.core.util.Arrays;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>import</span> org.junit.jupiter.api.Test;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f92672>import</span> org.springframework.boot.test.autoconfigure.json.JsonTest;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f92672>import</span> org.springframework.boot.test.json.JacksonTester;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#f92672>import</span> java.io.IOException;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f92672>import static</span> org.assertj.core.api.Assertions.assertThat;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#a6e22e>@JsonTest</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CashCardJsonTest</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#66d9ef>private</span> JacksonTester<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> json;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#66d9ef>private</span> JacksonTester<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>[]&gt;</span> jsonList;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cashCardSerializationTest</span>() <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        CashCard cashCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(99L, 123.<span style=color:#a6e22e>45</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        assertThat(json.<span style=color:#a6e22e>write</span>(cashCard)).<span style=color:#a6e22e>isStrictlyEqualToJson</span>(<span style=color:#e6db74>&#34;expected.json&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        assertThat(json.<span style=color:#a6e22e>write</span>(cashCard)).<span style=color:#a6e22e>hasJsonPathNumberValue</span>(<span style=color:#e6db74>&#34;@.id&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        assertThat(json.<span style=color:#a6e22e>write</span>(cashCard)).<span style=color:#a6e22e>extractingJsonPathNumberValue</span>(<span style=color:#e6db74>&#34;@.id&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>                .<span style=color:#a6e22e>isEqualTo</span>(99);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        assertThat(json.<span style=color:#a6e22e>write</span>(cashCard)).<span style=color:#a6e22e>hasJsonPathNumberValue</span>(<span style=color:#e6db74>&#34;@.amount&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        assertThat(json.<span style=color:#a6e22e>write</span>(cashCard)).<span style=color:#a6e22e>extractingJsonPathNumberValue</span>(<span style=color:#e6db74>&#34;@.amount&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                .<span style=color:#a6e22e>isEqualTo</span>(123.<span style=color:#a6e22e>45</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cashCardDeserializationTest</span>() <span style=color:#66d9ef>throws</span> IOException {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        String expected <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#e6db74>           {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#e6db74>               &#34;id&#34;:99,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#e6db74>               &#34;amount&#34;:123.45
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#e6db74>           }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#e6db74>           &#34;&#34;&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>        assertThat(json.<span style=color:#a6e22e>parse</span>(expected))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>                .<span style=color:#a6e22e>isEqualTo</span>(<span style=color:#66d9ef>new</span> CashCard(99L, 123.<span style=color:#a6e22e>45</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        assertThat(json.<span style=color:#a6e22e>parseObject</span>(expected).<span style=color:#a6e22e>id</span>()).<span style=color:#a6e22e>isEqualTo</span>(99);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>        assertThat(json.<span style=color:#a6e22e>parseObject</span>(expected).<span style=color:#a6e22e>amount</span>()).<span style=color:#a6e22e>isEqualTo</span>(123.<span style=color:#a6e22e>45</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>}
</span></span></code></pre></div><p>expected.json:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>99</span>,  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;amount&#34;</span>: <span style=color:#ae81ff>123.45</span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=get-post-單筆資料-api>GET, POST 單筆資料 API<a href=#get-post-單筆資料-api class=hanchor arialabel=Anchor>#</a></h2><ul><li>透過id獲取單筆資訊</li><li>post新增一筆新的資料</li></ul><h3 id=測試程式>測試程式<a href=#測試程式 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@SpringBootTest</span>(webEnvironment <span style=color:#f92672>=</span> SpringBootTest.<span style=color:#a6e22e>WebEnvironment</span>.<span style=color:#a6e22e>RANDOM_PORT</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CashCardApplicationTests</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	TestRestTemplate restTemplate;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldReturnACashCardWhenDataIsSaved</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/1&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>		DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(response.<span style=color:#a6e22e>getBody</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>		Number id <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.id&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#75715e>//		assertThat(id).isNotNull();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>		assertThat(id).<span style=color:#a6e22e>isEqualTo</span>(1);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>		Double amount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.amount&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>		assertThat(amount).<span style=color:#a6e22e>isEqualTo</span>(123.<span style=color:#a6e22e>45</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotReturnACashCardWithAnUnknownId</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/1000&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>		assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		assertThat(response.<span style=color:#a6e22e>getBody</span>()).<span style=color:#a6e22e>isBlank</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#75715e>// 測試 POST 方法</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	<span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldCreateANewCashCard</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>		<span style=color:#75715e>// DB 自動生成ID，因此這裡不需要提供</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>		CashCard newCashCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, 250.<span style=color:#a6e22e>00</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>		<span style=color:#75715e>// POST 之後不用 return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>		ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> createResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>postForEntity</span>(<span style=color:#e6db74>&#34;/cashcards&#34;</span>, newCashCard, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>		assertThat(createResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>}
</span></span></code></pre></div><h3 id=實作-api--spring-uricomponentsbuilder-介紹>實作 API &ndash; Spring <code>UriComponentsBuilder</code> 介紹<a href=#實作-api--spring-uricomponentsbuilder-介紹 class=hanchor arialabel=Anchor>#</a></h3><ul><li>在 Web 應用程式中動態產生、修改與擴展網址，減少手動字串拼接帶來的錯誤與繁瑣</li></ul><h4 id=範例>範例<a href=#範例 class=hanchor arialabel=Anchor>#</a></h4><ul><li>post API &ndash; 成功後不回傳 response body</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@PostMapping</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createCashCard</span>(<span style=color:#a6e22e>@RequestBody</span> CashCard newCashCardRequest, UriComponentsBuilder ucb) {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#75715e>// inject UriComponentsBuilder  </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    CashCard savedCashCard <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>save</span>(newCashCardRequest); <span style=color:#75715e>// save() returns the saved entity with an ID  </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    URI locationOfNewCashCard <span style=color:#f92672>=</span> ucb  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            .<span style=color:#a6e22e>path</span>(<span style=color:#e6db74>&#34;cashcards/{id}&#34;</span>)  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            .<span style=color:#a6e22e>buildAndExpand</span>(savedCashCard.<span style=color:#a6e22e>id</span>())  <span style=color:#75715e>// 在URI當中插入變數</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            .<span style=color:#a6e22e>toUri</span>();  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;New CashCard location: &#34;</span> <span style=color:#f92672>+</span> locationOfNewCashCard);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>created</span>(locationOfNewCashCard).<span style=color:#a6e22e>build</span>();  <span style=color:#75715e>// 組裝並產生一個 HTTP 回應物件 (ResponseEntity)，回傳 HTTP 201 Created 回應</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><ul><li>post API 成功後回傳 response body</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>created</span>(locationOfNewCashCard).<span style=color:#a6e22e>body</span>(...); 
</span></span></code></pre></div><h3 id=實作-api--程式碼>實作 API &ndash; 程式碼<a href=#實作-api--程式碼 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> com.springacademy.cashcard;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> org.springframework.http.ResponseEntity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.*;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f92672>import</span> org.springframework.web.util.UriComponentsBuilder;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f92672>import</span> java.net.URI;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f92672>import</span> java.util.Optional;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/cashcards&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CashCardController</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> CashCardRepository cashCardRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>CashCardController</span>(CashCardRepository cashCardRepository) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cashCardRepository</span> <span style=color:#f92672>=</span> cashCardRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/{requestedId}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>@PathVariable</span> Long requestedId) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        Optional<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> cashCardOptional <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>findById</span>(requestedId);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#66d9ef>if</span> (cashCardOptional.<span style=color:#a6e22e>isPresent</span>()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(cashCardOptional.<span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>            <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>notFound</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#75715e>//    @PostMapping</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e>//    private ResponseEntity&lt;Void&gt; createCashCard() {</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#75715e>//        return null; // 如果return null，會自動生成 200 OK status，測試通過</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#75715e>//    }</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#a6e22e>@PostMapping</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>    <span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createCashCard</span>(<span style=color:#a6e22e>@RequestBody</span> CashCard newCashCardRequest, UriComponentsBuilder ucb) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#75715e>// inject UriComponentsBuilder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>        CashCard savedCashCard <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>save</span>(newCashCardRequest); <span style=color:#75715e>// save() returns the saved entity with an ID</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>        URI locationOfNewCashCard <span style=color:#f92672>=</span> ucb
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>                .<span style=color:#a6e22e>path</span>(<span style=color:#e6db74>&#34;cashcards/{id}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>                .<span style=color:#a6e22e>buildAndExpand</span>(savedCashCard.<span style=color:#a6e22e>id</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>                .<span style=color:#a6e22e>toUri</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;New CashCard location: &#34;</span> <span style=color:#f92672>+</span> locationOfNewCashCard);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>created</span>(locationOfNewCashCard).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    }}
</span></span></code></pre></div><h2 id=get-列出所有-cashcards-資料>GET 列出所有 CashCards 資料<a href=#get-列出所有-cashcards-資料 class=hanchor arialabel=Anchor>#</a></h2><h3 id=pagingandsortingrepository-分頁>PagingAndSortingRepository 分頁<a href=#pagingandsortingrepository-分頁 class=hanchor arialabel=Anchor>#</a></h3><ul><li>優化查詢效能，縮短使用者的等待時間</li><li>明確設定排序方式，不建議使用預設排序，以免造成資料難以維護與測試</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@GetMapping</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>findAll</span>(Pageable pageable) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   Page<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> page <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>findAll</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>           PageRequest.<span style=color:#a6e22e>of</span>(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>                   pageable.<span style=color:#a6e22e>getPageNumber</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>                   pageable.<span style=color:#a6e22e>getPageSize</span>(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>                   pageable.<span style=color:#a6e22e>getSortOr</span>(Sort.<span style=color:#a6e22e>by</span>(Sort.<span style=color:#a6e22e>Direction</span>.<span style=color:#a6e22e>DESC</span>, <span style=color:#e6db74>&#34;amount&#34;</span>))));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>   <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(page.<span style=color:#a6e22e>getContent</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>對應的 API URL 例如: <code>/cashcards?page=1&amp;size=3&amp;sort=amount,desc</code></p><ul><li>Pageable 物件會自動解析網址中的 page, size, sort 參數</li><li>用<code>.getContent()</code> 來只取出資料內容，不回傳分頁資訊</li></ul><h4 id=更新-repository-class-來應用-paging-與-sorting>更新 Repository class 來應用 paging 與 sorting<a href=#更新-repository-class-來應用-paging-與-sorting class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#f92672>package</span> com.springacademy.cashcard;  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.CrudRepository;  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.PagingAndSortingRepository;  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CashCardRepository</span> <span style=color:#66d9ef>extends</span> CrudRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span>, PagingAndSortingRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span> {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><h4 id=page-物件格式範例>Page 物件格式範例<a href=#page-物件格式範例 class=hanchor arialabel=Anchor>#</a></h4><ul><li>content 當中包含實際資料</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;content&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;amount&#34;</span>: <span style=color:#ae81ff>10.0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;amount&#34;</span>: <span style=color:#ae81ff>0.19</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;pageable&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pageNumber&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pageSize&#34;</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;totalElements&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;totalPages&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;first&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;last&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h1 id=part-2-spring-boot-restful-api-結合-spring-security>Part 2: Spring Boot Restful API 結合 Spring Security<a href=#part-2-spring-boot-restful-api-結合-spring-security class=hanchor arialabel=Anchor>#</a></h1><h2 id=security-觀念介紹>Security 觀念介紹<a href=#security-觀念介紹 class=hanchor arialabel=Anchor>#</a></h2><h3 id=same-origin-policy>Same Origin Policy<a href=#same-origin-policy class=hanchor arialabel=Anchor>#</a></h3><ul><li>如果兩個 URL 的protocol 、port 和 host 相同，則這兩個 URL 就是相同的origin</li><li>SOP是一種安全機制，限制只有來自相同來源的腳本程式才能向該來源發送請求</li><li>有助於減少可能的攻擊媒介。例如：防止惡意網站在使用者的瀏覽器中偷偷執行 JavaScript，去讀取使用者登入的 Webmail 服務資料，或是讀取一些只能在公司內部使用、沒有對外開放的內部網站內容，然後再把這些資料偷偷傳給攻擊者</li></ul><hr><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy>Same-origin policy - Security | MDN</a></li></ul><hr><h3 id=cross-origin-resource-sharing-cors>Cross-Origin Resource Sharing (CORS)<a href=#cross-origin-resource-sharing-cors class=hanchor arialabel=Anchor>#</a></h3><ul><li>現在系統經常由多個微服務構成，各自部署在不同的 URI 下。這樣就需要透過 CORS（跨來源資源共用） 來讓不同來源之間的請求被接受</li><li>Spring Security 提供 <code>@CrossOrigin</code> 註解用來設定被允許的來源；但是如果使用了 <code>@CrossOrigin</code> 而未指定任何來源，則預設為開放所有來源，會造成安全風險</li></ul><h3 id=authentication-認證--authorization-授權>Authentication (認證) & Authorization (授權)<a href=#authentication-認證--authorization-授權 class=hanchor arialabel=Anchor>#</a></h3><blockquote><p>在 API 的使用者中，可能是人，也可能是另一個程式，因此常使用"<strong>Principal</strong>&ldquo;這個詞來代替"使用者&rdquo;</p></blockquote><ul><li>認證是讓主體向系統證明自己的身分，當主體提供了正確的憑證，就可以稱該主體已驗證（Authenticated）</li><li>認證的接下來是授權，授權的目的是<strong>區分不同使用者的權限</strong>，決定哪些操作是被允許的</li></ul><h4 id=authentication-session>Authentication Session<a href=#authentication-session class=hanchor arialabel=Anchor>#</a></h4><ul><li>由於 HTTP 是 stateless protocol，每一個請求都必須自行攜帶能證明使用者身分的資訊，效率較低，因此這裡採用Authentication Session (又可稱作 Auth Session, Session) 的方式</li><li>作法是生成一組隨機字串作為<strong>Session Token</strong>，並將其儲存在用戶端的 <strong>Cookie</strong> 中</li></ul><h5 id=什麼是-cookie>什麼是 Cookie<a href=#什麼是-cookie class=hanchor arialabel=Anchor>#</a></h5><ul><li>Cookie 是儲存在瀏覽器端的一組資料，會自動隨著對應的 URI 一起傳送到伺服器</li><li>Cookie 的兩大優點：<ol><li><strong>自動隨每次請求送出</strong>，不需額外撰寫程式碼；</li><li><strong>具有持久性</strong>，即使關閉網頁後再次造訪仍可維持登入狀態，提升使用者體驗</li></ol></li></ul><h3 id=role-based-access-controlrbac>Role-Based Access Control（RBAC）<a href=#role-based-access-controlrbac class=hanchor arialabel=Anchor>#</a></h3><ul><li>Spring Security 採用 RBAC 來進行授權控制</li><li>每個主體（Principal）都擁有一組角色（Roles）</li><li>每項資源或操作會定義哪些角色可以存取</li><li>RBAC 可應用在整體架構（全域）或單一方法層級上</li><li>例如：<ul><li>擁有「管理員角色」的使用者可執行更多操作</li><li>「卡片擁有者角色」則限制於個人卡片管理</li></ul></li></ul><h3 id=常見的網頁攻擊web-exploits>常見的網頁攻擊（Web Exploits）<a href=#常見的網頁攻擊web-exploits class=hanchor arialabel=Anchor>#</a></h3><h4 id=跨站請求偽造cross-site-request-forgery-csrf>跨站請求偽造（Cross-Site Request Forgery, CSRF）<a href=#跨站請求偽造cross-site-request-forgery-csrf class=hanchor arialabel=Anchor>#</a></h4><blockquote><p>Spring Security 預設啟用 CSRF 保護，開發者無須額外設定即可使用</p></blockquote><ul><li>使用者在登入一網站之後造訪其他惡意網站，讓惡意網站有機會假冒使用者的身份來發送非法的請求給其他網站</li><li>受害網站無法辨別請求是否為合法操作</li></ul><h4 id=跨站腳本攻擊cross-site-scripting-xss>跨站腳本攻擊（Cross-Site Scripting, XSS）<a href=#跨站腳本攻擊cross-site-scripting-xss class=hanchor arialabel=Anchor>#</a></h4><ul><li>將惡意腳本注入到網站內容中，使受害者在瀏覽網頁時自動執行該腳本</li></ul><h2 id=gradlebuild-加入-spring-security-dependency>Gradle.build 加入 Spring Security dependency<a href=#gradlebuild-加入-spring-security-dependency class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gradle data-lang=gradle><span style=display:flex><span>dependencies <span style=color:#f92672>{</span>  
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span>  
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-security&#39;</span>  
</span></span><span style=display:flex><span>    testImplementation <span style=color:#e6db74>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span>  
</span></span><span style=display:flex><span>    testRuntimeOnly <span style=color:#e6db74>&#39;org.junit.platform:junit-platform-launcher&#39;</span>  
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;org.springframework.data:spring-data-jdbc&#39;</span>  
</span></span><span style=display:flex><span>    implementation <span style=color:#e6db74>&#39;com.h2database:h2&#39;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><img src=/blog/images/gradle_image.png alt=alt></p><p>⭢ Spring Boot 預設會開啟安全機制保護所有 HTTP 路徑（<code>/**</code>），因此所有 API 都需要身份驗證（比如帳號密碼）才能存取，所有受保護的 endpoint 都會回傳 <code>401 Unauthorized</code></p><h2 id=設置-spring-security>設置 Spring Security<a href=#設置-spring-security class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> com.springacademy.cashcard;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f92672>import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f92672>import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f92672>import</span> org.springframework.security.crypto.password.PasswordEncoder;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#f92672>import</span> org.springframework.security.web.SecurityFilterChain;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityConfig</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    SecurityFilterChain <span style=color:#a6e22e>filterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    PasswordEncoder <span style=color:#a6e22e>passwordEncoder</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> BCryptPasswordEncoder();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><h3 id=configuration-註解>@Configuration 註解<a href=#configuration-註解 class=hanchor arialabel=Anchor>#</a></h3><ul><li>加上註解的class代表該class是一個用來設定 Bean 的類別</li><li>@Configuration class 當中定義的 bean 都會被 spring container註冊起來，在後續專案中使用該設定，不然會使用預設的設定</li></ul><h3 id=bean-註解>@Bean 註解<a href=#bean-註解 class=hanchor arialabel=Anchor>#</a></h3><ul><li>用來<strong>標記方法</strong>，表示這個方法會<strong>回傳一個物件</strong></li></ul><h2 id=設置基礎的-authentication>設置基礎的 Authentication<a href=#設置基礎的-authentication class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>SecurityFilterChain <span style=color:#a6e22e>filterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	http
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>			.<span style=color:#a6e22e>authorizeHttpRequests</span>(request <span style=color:#f92672>-&gt;</span> request
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>					.<span style=color:#a6e22e>requestMatchers</span>(<span style=color:#e6db74>&#34;/cashcards/**&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>					.<span style=color:#a6e22e>authenticated</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>			.<span style=color:#a6e22e>httpBasic</span>(Customizer.<span style=color:#a6e22e>withDefaults</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>			.<span style=color:#a6e22e>csrf</span>(csrf <span style=color:#f92672>-&gt;</span> csrf.<span style=color:#a6e22e>disable</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>UserDetailsService <span style=color:#a6e22e>testOnlyUsers</span>(PasswordEncoder passwordEncoder) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	User.<span style=color:#a6e22e>UserBuilder</span> users <span style=color:#f92672>=</span> User.<span style=color:#a6e22e>builder</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	UserDetails sarah <span style=color:#f92672>=</span> users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>			.<span style=color:#a6e22e>username</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>			.<span style=color:#a6e22e>password</span>(passwordEncoder.<span style=color:#a6e22e>encode</span>(<span style=color:#e6db74>&#34;abc123&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>			.<span style=color:#a6e22e>roles</span>() <span style=color:#75715e>// No roles for now</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>			.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> InMemoryUserDetailsManager(sarah);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><ul><li>如果 API 是給<em>非瀏覽器客戶端（non-browser clients</em>）使用的，就可以關閉 CSRF 保護</li><li>此範例中是實作 Restful API，並不涉及 cookie/session 式身份驗證，因此可以選擇關閉 CSRF 保護機制</li></ul><h3 id=測試認證功能>測試認證功能<a href=#測試認證功能 class=hanchor arialabel=Anchor>#</a></h3><h4 id=test-data-sql>test data (sql)<a href=#test-data-sql class=hanchor arialabel=Anchor>#</a></h4><p>main/resources/schema.sql</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> cash_card  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>(  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>   ID     BIGINT <span style=color:#66d9ef>GENERATED</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>IDENTITY</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>   AMOUNT   NUMBER <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#ae81ff>0</span>,  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>   <span style=color:#66d9ef>OWNER</span>    VARCHAR(<span style=color:#ae81ff>256</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>);
</span></span></code></pre></div><p>test/resources/data.sql</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> CASH_CARD(ID, AMOUNT, <span style=color:#66d9ef>OWNER</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>00</span>, <span style=color:#e6db74>&#39;sarah1&#39;</span>);
</span></span></code></pre></div><h4 id=單元測試>單元測試<a href=#單元測試 class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldReturnACashCardWhenDataIsSaved</span>() {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>          .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>) <span style=color:#75715e>// update  </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>          .<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/100&#34;</span>, String.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(response.<span style=color:#a6e22e>getBody</span>());  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    Number id <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.id&#34;</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    assertThat(id).<span style=color:#a6e22e>isEqualTo</span>(100);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    Double amount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.amount&#34;</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    assertThat(amount).<span style=color:#a6e22e>isEqualTo</span>(1.<span style=color:#a6e22e>0</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><h2 id=實作-rbac>實作 RBAC<a href=#實作-rbac class=hanchor arialabel=Anchor>#</a></h2><ul><li>測試ROLES認證功能</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldRejectUsersWhoAreNotCardOwners</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;hank-owns-no-cards&#34;</span>, <span style=color:#e6db74>&#34;qrs456&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      .<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/99&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>FORBIDDEN</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><ul><li>增加更多不同ROLES</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>UserDetailsService <span style=color:#a6e22e>testOnlyUsers</span>(PasswordEncoder passwordEncoder) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  User.<span style=color:#a6e22e>UserBuilder</span> users <span style=color:#f92672>=</span> User.<span style=color:#a6e22e>builder</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  UserDetails sarah <span style=color:#f92672>=</span> users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    .<span style=color:#a6e22e>username</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    .<span style=color:#a6e22e>password</span>(passwordEncoder.<span style=color:#a6e22e>encode</span>(<span style=color:#e6db74>&#34;abc123&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    .<span style=color:#a6e22e>roles</span>(<span style=color:#e6db74>&#34;CARD-OWNER&#34;</span>) <span style=color:#75715e>// new role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  UserDetails hankOwnsNoCards <span style=color:#f92672>=</span> users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    .<span style=color:#a6e22e>username</span>(<span style=color:#e6db74>&#34;hank-owns-no-cards&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    .<span style=color:#a6e22e>password</span>(passwordEncoder.<span style=color:#a6e22e>encode</span>(<span style=color:#e6db74>&#34;qrs456&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    .<span style=color:#a6e22e>roles</span>(<span style=color:#e6db74>&#34;NON-OWNER&#34;</span>) <span style=color:#75715e>// new role</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> InMemoryUserDetailsManager(sarah, hankOwnsNoCards);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span></code></pre></div><ul><li>更新 FilterChain</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>SecurityFilterChain <span style=color:#a6e22e>filterChain</span>(HttpSecurity http) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>     http
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>             .<span style=color:#a6e22e>authorizeHttpRequests</span>(request <span style=color:#f92672>-&gt;</span> request
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>                     .<span style=color:#a6e22e>requestMatchers</span>(<span style=color:#e6db74>&#34;/cashcards/**&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                     .<span style=color:#a6e22e>hasRole</span>(<span style=color:#e6db74>&#34;CARD-OWNER&#34;</span>)) <span style=color:#75715e>// enable RBAC: Replace the .authenticated() call with the hasRole(...) call.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>             .<span style=color:#a6e22e>httpBasic</span>(Customizer.<span style=color:#a6e22e>withDefaults</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>             .<span style=color:#a6e22e>csrf</span>(csrf <span style=color:#f92672>-&gt;</span> csrf.<span style=color:#a6e22e>disable</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>     <span style=color:#66d9ef>return</span> http.<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>⭢ 問題：任何已驗證並擁有 <code>CARD-OWNER</code> 角色的使用者，都可以查看其他人的 CashCards</p><h3 id=更新-cashcardrepository-以限制查詢資料範圍>更新 <code>CashCardRepository</code> 以限制查詢資料範圍<a href=#更新-cashcardrepository-以限制查詢資料範圍 class=hanchor arialabel=Anchor>#</a></h3><blockquote><p>不應依賴框架去做所有資料保護</p></blockquote><h4 id=新增一名使用者>新增一名使用者<a href=#新增一名使用者 class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> CASH_CARD(ID, AMOUNT, <span style=color:#66d9ef>OWNER</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>102</span>, <span style=color:#ae81ff>200</span>.<span style=color:#ae81ff>00</span>, <span style=color:#e6db74>&#39;kumar2&#39;</span>);
</span></span></code></pre></div><h4 id=測試不能存取別人的資料>測試<em>不能</em>存取別人的資料<a href=#測試不能存取別人的資料 class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotAllowAccessToCashCardsTheyDoNotOwn</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>      .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>      .<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/102&#34;</span>, String.<span style=color:#a6e22e>class</span>); <span style=color:#75715e>// kumar2 的資料</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>error:</p><pre tabindex=0><code>Expected :404 NOT_FOUND
Actual   :200 OK
&lt;Click to see difference&gt;

org.opentest4j.AssertionFailedError: 
expected: 404 NOT_FOUND
 but was: 200 OK
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)
	at com.springacademy.cashcard.CashCardApplicationTests.shouldNotAllowAccessToCashCardsTheyDoNotOwn(CashcardApplicationTests.java:178)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
</code></pre><p>透過以下測試可以發現，<strong>資料查詢未過濾 OWNER，看到不該看的資料</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldReturnAllCashCardsWhenListIsRequested</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>		ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>				.<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>				.<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(response.<span style=color:#a6e22e>getBody</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		<span style=color:#66d9ef>int</span> cashCardCount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.length()&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		assertThat(cashCardCount).<span style=color:#a6e22e>isEqualTo</span>(3);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span></code></pre></div><h4 id=更新-cashcardrepository-來過濾-owner>更新 <code>CashCardRepository</code> 來過濾 owner<a href=#更新-cashcardrepository-來過濾-owner class=hanchor arialabel=Anchor>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#f92672>import</span> org.springframework.data.domain.Page;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#f92672>import</span> org.springframework.data.domain.PageRequest;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.CrudRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.PagingAndSortingRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CashCardRepository</span> <span style=color:#66d9ef>extends</span> CrudRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span>, PagingAndSortingRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    CashCard <span style=color:#a6e22e>findByIdAndOwner</span>(Long id, String owner);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    Page<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findByOwner</span>(String owner, PageRequest pageRequest);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h3 id=更新-controller-來應用過濾-owner-的功能>更新 Controller 來應用過濾 owner 的功能<a href=#更新-controller-來應用過濾-owner-的功能 class=hanchor arialabel=Anchor>#</a></h3><p>在 Spring Security 裡，當使用者通過身份驗證後，系統會提供一個 <code>Principal</code> 物件來代表這位使用者</p><ul><li><code>Principal</code> 包含使用者的登入資訊</li><li>可以使用 <code>principal.getName()</code> 取得該使用者的帳號名稱（Basic Auth 傳進來的 username）</li></ul><p>⭢ 把 <code>Principal</code> 當作參數加入方法中，使用 findByIdAndOwner(&mldr;) 來確保只查詢該使用者自己的CashCards</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/{requestedId}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>@PathVariable</span> Long requestedId, Principal principal) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	Optional<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> cashCardOptional <span style=color:#f92672>=</span> Optional.<span style=color:#a6e22e>ofNullable</span>(cashCardRepository.<span style=color:#a6e22e>findByIdAndOwner</span>(requestedId, principal.<span style=color:#a6e22e>getName</span>()));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#66d9ef>if</span> (cashCardOptional.<span style=color:#a6e22e>isPresent</span>()) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>		<span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(cashCardOptional.<span style=color:#a6e22e>get</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>		<span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>notFound</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>@GetMapping</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;&gt;</span> <span style=color:#a6e22e>findAll</span>(Pageable pageable, Principal principal) {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Page<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> page <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>findByOwner</span>(principal.<span style=color:#a6e22e>getName</span>(),  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            PageRequest.<span style=color:#a6e22e>of</span>(  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    pageable.<span style=color:#a6e22e>getPageNumber</span>(),  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                    pageable.<span style=color:#a6e22e>getPageSize</span>(),  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                    pageable.<span style=color:#a6e22e>getSortOr</span>(Sort.<span style=color:#a6e22e>by</span>(Sort.<span style=color:#a6e22e>Direction</span>.<span style=color:#a6e22e>ASC</span>, <span style=color:#e6db74>&#34;amount&#34;</span>))  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            ));    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>ok</span>(page.<span style=color:#a6e22e>getContent</span>());  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><h3 id=測試-api>測試 API<a href=#測試-api class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldReturnAllCashCardsWhenListIsRequested</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#75715e>//		ResponseEntity&lt;String&gt; response = restTemplate.getForEntity(&#34;/cashcards&#34;, String.class);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>			.<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>			.<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(response.<span style=color:#a6e22e>getBody</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#66d9ef>int</span> cashCardCount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.length()&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	assertThat(cashCardCount).<span style=color:#a6e22e>isEqualTo</span>(3);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	JSONArray ids <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$..id&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	assertThat(ids).<span style=color:#a6e22e>containsExactlyInAnyOrder</span>(99, 100, 101);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	JSONArray amounts <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$..amount&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	assertThat(amounts).<span style=color:#a6e22e>containsExactlyInAnyOrder</span>(123.<span style=color:#a6e22e>45</span>, 1.<span style=color:#a6e22e>0</span>, 150.<span style=color:#a6e22e>00</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><p><img src=/blog/images/pstmn_image.png alt=alt></p><h3 id=新增功能的認證>新增功能的認證<a href=#新增功能的認證 class=hanchor arialabel=Anchor>#</a></h3><ul><li>測試 post API，使用一個有登入但沒有權限的帳號</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#a6e22e>@DirtiesContext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldCreateANewCashCard</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	CashCard newCashCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, 250.<span style=color:#a6e22e>00</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#75715e>//		ResponseEntity&lt;Void&gt; createResponse = restTemplate.postForEntity(&#34;/cashcards&#34;, newCashCard, Void.class);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> createResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>).<span style=color:#a6e22e>postForEntity</span>(<span style=color:#e6db74>&#34;/cashcards&#34;</span>, newCashCard, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	assertThat(createResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>CREATED</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	URI locationOfNewCashCard <span style=color:#f92672>=</span> createResponse.<span style=color:#a6e22e>getHeaders</span>().<span style=color:#a6e22e>getLocation</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> getResponse <span style=color:#f92672>=</span> restTemplate.<span style=color:#a6e22e>getForEntity</span>(locationOfNewCashCard, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	assertThat(getResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(getResponse.<span style=color:#a6e22e>getBody</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	Number id <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.id&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	Double amount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.amount&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	assertThat(id).<span style=color:#a6e22e>isNotNull</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	assertThat(amount).<span style=color:#a6e22e>isEqualTo</span>(250.<span style=color:#a6e22e>00</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><p>error:</p><pre tabindex=0><code>org.opentest4j.AssertionFailedError: 
expected: 201 CREATED
 but was: 403 FORBIDDEN
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)
	at com.springacademy.cashcard.CashCardApplicationTests.shouldCreateANewCashCard(CashcardApplicationTests.java:88)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
</code></pre><p>⮕ 更新 Controller</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@PostMapping</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>createCashCard</span>(<span style=color:#a6e22e>@RequestBody</span> CashCard newCashCardRequest, UriComponentsBuilder ucb, Principal principal) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	CashCard cashCardWithOwner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, newCashCardRequest.<span style=color:#a6e22e>amount</span>(), principal.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	CashCard savedCashCard <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>save</span>(cashCardWithOwner);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	URI locationOfNewCashCard <span style=color:#f92672>=</span> ucb
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>			.<span style=color:#a6e22e>path</span>(<span style=color:#e6db74>&#34;cashcards/{id}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>			.<span style=color:#a6e22e>buildAndExpand</span>(savedCashCard.<span style=color:#a6e22e>id</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>			.<span style=color:#a6e22e>toUri</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;New CashCard location: &#34;</span> <span style=color:#f92672>+</span> locationOfNewCashCard);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	<span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>created</span>(locationOfNewCashCard).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><hr><ul><li><a href=https://docs.spring.io/spring-security/site/docs/5.2.0.RELEASE/reference/html/index.html>Spring Security Reference docs.spring.io</a></li><li><a href=https://docs.spring.io/spring-security/reference/index.html>Spring Security :: Spring Security</a></li></ul><hr><h2 id=更新資料的方法-post-put-與-patch-的差異>更新資料的方法: POST, PUT 與 PATCH 的差異<a href=#更新資料的方法-post-put-與-patch-的差異 class=hanchor arialabel=Anchor>#</a></h2><table><thead><tr><th>HTTP 方法</th><th>操作</th><th>URI</th><th>功能說明</th><th>回傳狀態碼</th></tr></thead><tbody><tr><td>POST</td><td>建立</td><td><strong>由伺服器產生URI</strong>並回傳</td><td>建立一個資源</td><td>201 CREATED</td></tr><tr><td>PUT</td><td>建立</td><td>客戶端提供</td><td>建立一個資源</td><td>201 CREATED</td></tr><tr><td>PUT</td><td>更新</td><td>客戶端提供</td><td><strong>完整取代現有資料</strong></td><td>204 NO CONTENT</td></tr><tr><td>PATCH</td><td>更新</td><td>客戶端提供</td><td><strong>部分更新：只改變傳入欄位</strong></td><td>200 OK</td></tr></tbody></table><ul><li>POST 例如呼叫 <code>POST /cashcards</code>，會建立一個 <code>/cashcards/101</code> 資源</li><li>PUT 例如 <code>PUT /invoice/1234-567</code> 會直接放一個資源到這個 URI 上</li></ul><h2 id=put-更新-cashcards-的-amounts-資料>PUT 更新 CashCards 的 amounts 資料<a href=#put-更新-cashcards-的-amounts-資料 class=hanchor arialabel=Anchor>#</a></h2><h3 id=測試程式-1>測試程式<a href=#測試程式-1 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>import</span> org.springframework.http.HttpEntity;  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#f92672>import</span> org.springframework.http.HttpMethod;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#75715e>// 測試 PUT 方法  </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#a6e22e>@DirtiesContext</span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldUpdateAnExistingCashCard</span>() {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    CashCard cashCardUpdate <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, 19.<span style=color:#a6e22e>99</span>, <span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#75715e>//把 CashCard 包裝成一個 HTTP 請求實體（包含在 HTTP body 中）  </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    HttpEntity<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(cashCardUpdate);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>          .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>          .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/99&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, request, Void.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NO_CONTENT</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> getResponse <span style=color:#f92672>=</span> restTemplate  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>          .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>          .<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/99&#34;</span>, String.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    assertThat(getResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    DocumentContext documentContext <span style=color:#f92672>=</span> JsonPath.<span style=color:#a6e22e>parse</span>(getResponse.<span style=color:#a6e22e>getBody</span>());  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    Number id <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.id&#34;</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    Double amount <span style=color:#f92672>=</span> documentContext.<span style=color:#a6e22e>read</span>(<span style=color:#e6db74>&#34;$.amount&#34;</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    assertThat(id).<span style=color:#a6e22e>isEqualTo</span>(99);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    assertThat(amount).<span style=color:#a6e22e>isEqualTo</span>(19.<span style=color:#a6e22e>99</span>);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>}
</span></span></code></pre></div><ul><li>RestTemplate 一般的 PUT (<code>.put()</code>方法) 成功時會回傳 201或是200 response，因此沒有<code>putForEntity()</code>這個方法 => 使用 <code>exchange()</code> 方法替代</li><li><code>exhange(URL, HTTP方法, request HTTPEntity, response類型, ...URI變數)</code> 可以執行指定的HTTP方法並回傳 response entity</li></ul><h3 id=測試資料>測試資料<a href=#測試資料 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> CASH_CARD(ID, AMOUNT, <span style=color:#66d9ef>OWNER</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>99</span>, <span style=color:#ae81ff>100</span>.<span style=color:#ae81ff>00</span>, <span style=color:#e6db74>&#39;sarah1&#39;</span>);
</span></span></code></pre></div><h3 id=實作-api>實作 API<a href=#實作-api class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@PutMapping</span>(<span style=color:#e6db74>&#34;/{requestedId}&#34;</span>)  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>putCashCard</span>(<span style=color:#a6e22e>@PathVariable</span> Long requestedId, <span style=color:#a6e22e>@RequestBody</span> CashCard cashCardUpdate, Principal principal) {  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    CashCard cashCard <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>findByIdAndOwner</span>(requestedId, principal.<span style=color:#a6e22e>getName</span>());  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    CashCard updatedCashCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(cashCard.<span style=color:#a6e22e>id</span>(), cashCardUpdate.<span style=color:#a6e22e>amount</span>(), principal.<span style=color:#a6e22e>getName</span>());  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    cashCardRepository.<span style=color:#a6e22e>save</span>(updatedCashCard);  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>noContent</span>().<span style=color:#a6e22e>build</span>();  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>⭢ 回傳 HTTP 狀態碼 204 NO CONTENT，表示更新成功，但不附帶任何內容</p><h2 id=測試更新不存在的cashcards資料>測試更新不存在的CashCards資料<a href=#測試更新不存在的cashcards資料 class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotUpdateACashCardThatDoesNotExist</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    CashCard unknownCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, 19.<span style=color:#a6e22e>99</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    HttpEntity<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(unknownCard);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>            .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/99999&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, request, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>測試 Failed，錯誤如下:</p><pre tabindex=0><code>ava.lang.NullPointerException: Cannot invoke &#34;com.springacademy.cashcard.CashCard.id()&#34; because &#34;cashCard&#34; is null
...
org.opentest4j.AssertionFailedError: 
expected: 404 NOT_FOUND
 but was: 403 FORBIDDEN
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)
	at com.springacademy.cashcard.CashCardApplicationTests.shouldNotUpdateACashCardThatDoesNotExist(CashcardApplicationTests.java:238)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
</code></pre><h2 id=處理-nullpointerexception>處理 <code>NullPointerException</code><a href=#處理-nullpointerexception class=hanchor arialabel=Anchor>#</a></h2><h3 id=更新-controller-層的程式>更新 Controller 層的程式<a href=#更新-controller-層的程式 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@PutMapping</span>(<span style=color:#e6db74>&#34;/{requestedId}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>putCashCard</span>(<span style=color:#a6e22e>@PathVariable</span> Long requestedId, <span style=color:#a6e22e>@RequestBody</span> CashCard cashCardUpdate, Principal principal) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    CashCard cashCard <span style=color:#f92672>=</span> cashCardRepository.<span style=color:#a6e22e>findByIdAndOwner</span>(requestedId, principal.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#66d9ef>if</span> (cashCard <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        CashCard updatedCashCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(cashCard.<span style=color:#a6e22e>id</span>(), cashCardUpdate.<span style=color:#a6e22e>amount</span>(), principal.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        cashCardRepository.<span style=color:#a6e22e>save</span>(updatedCashCard);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>noContent</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>notFound</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><h2 id=測試更新他人的-cashcards-資料-未授權的情況>測試更新他人的 CashCards 資料 (未授權的情況)<a href=#測試更新他人的-cashcards-資料-未授權的情況 class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotUpdateACashCardThatIsOwnedBySomeoneElse</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    CashCard kumarsCard <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CashCard(<span style=color:#66d9ef>null</span>, 333.<span style=color:#a6e22e>33</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    HttpEntity<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HttpEntity<span style=color:#f92672>&lt;&gt;</span>(kumarsCard);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>            .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/102&#34;</span>, HttpMethod.<span style=color:#a6e22e>PUT</span>, request, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h2 id=執行-delete-方法後可能的-response>執行 DELETE 方法後可能的 response<a href=#執行-delete-方法後可能的-response class=hanchor arialabel=Anchor>#</a></h2><table><thead><tr><th>回應碼</th><th>使用情境</th></tr></thead><tbody><tr><td><code>204 NO CONTENT</code></td><td>該紀錄存在｜使用者（Principal）有授權｜紀錄成功被刪除</td></tr><tr><td><code>404 NOT FOUND</code></td><td>該紀錄不存在（也就是送了一個不存在的 ID）。</td></tr><tr><td><code>404 NOT FOUND</code></td><td>紀錄存在，但使用者並不是該紀錄的擁有者，沒有刪除權限。</td></tr></tbody></table><ul><li>沒有權限刪除會顯示404error的原因是為了避免洩漏資訊，如果記錄簿存在和無權限刪除兩個情況回應碼不同，惡意的使用者可以藉此猜出哪些資料存在，進而猜測資料庫結構或資料內容</li></ul><h2 id=hard-delete-vs-soft-delete>Hard Delete v.s. Soft Delete<a href=#hard-delete-vs-soft-delete class=hanchor arialabel=Anchor>#</a></h2><h3 id=hard-delete>Hard Delete<a href=#hard-delete class=hanchor arialabel=Anchor>#</a></h3><ul><li>直接刪除DB當中的資料，無法復原</li><li>日後需要那筆資料的話就會找不到</li></ul><p>⭢ 刪除成功後的response 可能是 <code>204 NO CONTENT</code></p><h3 id=soft-delete>Soft Delete<a href=#soft-delete class=hanchor arialabel=Anchor>#</a></h3><ul><li>並沒有真正的刪除資料，而是加上一個「已刪除」的標記</li><li>例如加上 IS_DELETE欄位存放 boolean，或是加上 DELETED_DATE Timestamp</li></ul><p>⭢ 刪除成功後的response 可能是 <code>200 OK</code></p><h2 id=稽核紀錄audit-trail與歸檔archiving>稽核紀錄（Audit Trail）與歸檔（Archiving）<a href=#稽核紀錄audit-trail與歸檔archiving class=hanchor arialabel=Anchor>#</a></h2><p>在實際使用資料庫時，經常會有需求要保留資料的變更紀錄。例如：</p><ul><li>客服可能需要知道使用者什麼時候刪除了某張 Cash Card。</li><li>有些法律規範要求，刪除的資料必須保留一段時間。
如果採用硬刪除，那我們就需要額外儲存這些資訊。以下是常見做法：</li></ul><ol><li><strong>歸檔（Archive）</strong>：<br>將刪除的資料搬到另一個位置（資料表或資料庫）。</li><li><strong>加入稽核欄位（Audit Fields）</strong>，例如：<ul><li><code>DELETED_DATE</code>：刪除的時間</li><li><code>DELETED_BY_USER</code>：誰刪的</li><li><em>也可以用在新增和更新上</em></li></ul></li><li><strong>稽核紀錄（Audit Trail）</strong>：保存每一筆操作的完整記錄（不只是最近一次）。這些紀錄可以存在另一個資料表，或是或日誌檔案（log file）</li></ol><h2 id=delete-刪除單筆-cashcards-資料>DELETE 刪除單筆 CashCards 資料<a href=#delete-刪除單筆-cashcards-資料 class=hanchor arialabel=Anchor>#</a></h2><h3 id=測試程式-2>測試程式<a href=#測試程式-2 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#a6e22e>@DirtiesContext</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldDeleteAnExistingCashCard</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> response <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/99&#34;</span>, HttpMethod.<span style=color:#a6e22e>DELETE</span>, <span style=color:#66d9ef>null</span>, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    assertThat(response.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NO_CONTENT</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	ResponseEntity<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> getResponse <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	            .<span style=color:#a6e22e>getForEntity</span>(<span style=color:#e6db74>&#34;/cashcards/99&#34;</span>, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    assertThat(getResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><h3 id=實作-api-1>實作 API<a href=#實作-api-1 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@DeleteMapping</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>deleteCashCard</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    cashCardRepository.<span style=color:#a6e22e>deleteById</span>(id); <span style=color:#75715e>// Add this line</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>noContent</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><h2 id=測試刪除不存在的-cashcards-資料>測試刪除不存在的 CashCards 資料<a href=#測試刪除不存在的-cashcards-資料 class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotDeleteACashCardThatDoesNotExist</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> deleteResponse <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/99999&#34;</span>, HttpMethod.<span style=color:#a6e22e>DELETE</span>, <span style=color:#66d9ef>null</span>, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    assertThat(deleteResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>測試 Failed，錯誤如下:</p><pre tabindex=0><code>Expected :404 NOT_FOUND
Actual   :204 NO_CONTENT
&lt;Click to see difference&gt;

org.opentest4j.AssertionFailedError: 
expected: 404 NOT_FOUND
 but was: 204 NO_CONTENT
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:500)
	at com.springacademy.cashcard.CashCardApplicationTests.shouldNotDeleteACashCardThatDoesNotExist(CashcardApplicationTests.java:271)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
</code></pre><p>⮕ 沒有處理「資料不存在」的情況
⮕ 呼叫 Spring Data JPA 的 deleteById() 方法，如果ID不存在，不會丟出例外，也不會拋錯</p><h3 id=更新-controller-層程式>更新 Controller 層程式<a href=#更新-controller-層程式 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@DeleteMapping</span>(<span style=color:#e6db74>&#34;/{id}&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#66d9ef>private</span> ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>deleteCashCard</span>(<span style=color:#a6e22e>@PathVariable</span> Long id, Principal principal) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#75715e>//        cashCardRepository.deleteById(id); // Add this line</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>cashCardRepository.<span style=color:#a6e22e>existsByIdAndOwner</span>(id, principal.<span style=color:#a6e22e>getName</span>())) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>notFound</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>        <span style=color:#66d9ef>return</span> ResponseEntity.<span style=color:#a6e22e>noContent</span>().<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    }
</span></span></code></pre></div><h3 id=更新-repository-層程式>更新 Repository 層程式<a href=#更新-repository-層程式 class=hanchor arialabel=Anchor>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>package</span> com.springacademy.cashcard;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#f92672>import</span> org.springframework.data.domain.Page;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>import</span> org.springframework.data.domain.PageRequest;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.CrudRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#f92672>import</span> org.springframework.data.repository.PagingAndSortingRepository;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CashCardRepository</span> <span style=color:#66d9ef>extends</span> CrudRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span>, PagingAndSortingRepository<span style=color:#f92672>&lt;</span>CashCard, Long<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    CashCard <span style=color:#a6e22e>findByIdAndOwner</span>(Long id, String owner);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    Page<span style=color:#f92672>&lt;</span>CashCard<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>findByOwner</span>(String owner, PageRequest pageRequest);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>existsByIdAndOwner</span>(Long id, String owner);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><h2 id=測試刪除未授權存取的-cashcards-資料>測試刪除未授權存取的 CashCards 資料<a href=#測試刪除未授權存取的-cashcards-資料 class=hanchor arialabel=Anchor>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shouldNotAllowDeletionOfCashCardsTheyDoNotOwn</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ResponseEntity<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> deleteResponse <span style=color:#f92672>=</span> restTemplate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            .<span style=color:#a6e22e>withBasicAuth</span>(<span style=color:#e6db74>&#34;sarah1&#34;</span>, <span style=color:#e6db74>&#34;abc123&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            .<span style=color:#a6e22e>exchange</span>(<span style=color:#e6db74>&#34;/cashcards/102&#34;</span>, HttpMethod.<span style=color:#a6e22e>DELETE</span>, <span style=color:#66d9ef>null</span>, Void.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    assertThat(deleteResponse.<span style=color:#a6e22e>getStatusCode</span>()).<span style=color:#a6e22e>isEqualTo</span>(HttpStatus.<span style=color:#a6e22e>NOT_FOUND</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><a href=https://kinako890419.github.io/blog/posts/hello-terminal/ class="button inline prev">&lt; [<span class=button__text>自我介紹</span>]
</a>::
<a href=https://kinako890419.github.io/blog/posts/2025-plurk-hotwater-bot/ class="button inline next">[<span class=button__text>多喝熱水2.0</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/blog/bundle.min.js></script></div></body></html>